<!DOCTYPE html>
<html>
<head>
    <title>Hebrew Calendar & Zmanim</title>
    <script src="assets/luxon.min.js"></script>
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>
    <div class="container">
        <h1>Hebrew Calendar & Zmanim</h1>

        <div class="input-group">
            <label>Latitude: </label>
            <input type="number" id="latitude" step="0.001" placeholder="Enter latitude">
        </div>
        <div class="input-group">
            <label>Longitude: </label>
            <input type="number" id="longitude" step="0.001" placeholder="Enter longitude">
        </div>

        <button onclick="findMe()">Find Me</button>
        <button onclick="calculateAll()">Get All Times</button>

        <div id="result"></div>
        <div id="shabbat"></div>
        <div id="zmanim"></div>
    </div>

    <script>
        // Check if Luxon is loaded
        if (typeof luxon === 'undefined') {
            alert('Error: Luxon library not loaded. Please check your installation.');
        }

        function findMe() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        document.getElementById('latitude').value = position.coords.latitude.toFixed(3);
                        document.getElementById('longitude').value = position.coords.longitude.toFixed(3);
                        calculateAll();
                    },
                    error => {
                        alert("Error getting location: " + error.message);
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        async function calculateAll() {
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;

            if (!lat || !lon) {
                alert("Please enter latitude and longitude");
                return;
            }

            // Show loading states
            document.getElementById('result').innerHTML = '<div class="loading">Loading date information...</div>';
            document.getElementById('zmanim').innerHTML = '<div class="loading">Loading zmanim...</div>';
            document.getElementById('shabbat').innerHTML = '<div class="loading">Loading Shabbat times...</div>';

            try {
                // Basic Hebrew date using Luxon
                displayHebrewDate();

                // Get Zmanim from Hebcal API
                await fetchZmanim(lat, lon);

                // Get Shabbat times from Hebcal API
                await fetchShabbatTimes(lat, lon);

                // Get next holiday
                const holidayInfo = await fetchNextHoliday(lat, lon);
                if (holidayInfo) {
                    document.getElementById('result').innerHTML += holidayInfo;
                }
            } catch (error) {
                console.error('Calculation error:', error);
            }
        }

        function displayHebrewDate() {
            const now = luxon.DateTime.now().setZone('local');
            const hebrewDateHebrew = now.toLocaleString({
                calendar: 'hebrew',
                numberingSystem: 'latn',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            }, 'he');

            const hebrewDateEnglish = now.toLocaleString({
                calendar: 'hebrew',
                numberingSystem: 'latn',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            }, 'en');

            document.getElementById('result').innerHTML = `
                <div class="hebrew-date">
                    ${hebrewDateHebrew}<br>
                    ${hebrewDateEnglish}
                </div>
            `;
        }

        async function fetchZmanim(lat, lon) {
            const today = new Date().toISOString().split('T')[0];
            const url = `https://www.hebcal.com/zmanim?cfg=json&latitude=${lat}&longitude=${lon}&date=${today}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                let zmanimHtml = '<h2>Zmanim for Today</h2><div class="zmanim-grid">';
                for (const [key, value] of Object.entries(data.times)) {
                    if (typeof value === 'string') {
                        const time = new Date(value).toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        zmanimHtml += `
                            <div class="zman-item">
                                <strong>${key.replace(/([A-Z])/g, ' $1').trim()}:</strong>
                                <br>${time}
                            </div>
                        `;
                    }
                }
                zmanimHtml += '</div>';
                document.getElementById('zmanim').innerHTML = zmanimHtml;
            } catch (error) {
                document.getElementById('zmanim').innerHTML = `Error fetching zmanim: ${error.message}`;
            }
        }

        async function fetchShabbatTimes(lat, lon) {
            const today = new Date();
            const fridayOffset = (5 - today.getDay() + 7) % 7; // Days until next Friday
            const nextFriday = new Date(today);
            nextFriday.setDate(today.getDate() + fridayOffset);
            const dateStr = nextFriday.toISOString().split('T')[0];

            const url = `https://www.hebcal.com/shabbat?cfg=json&latitude=${lat}&longitude=${lon}&date=${dateStr}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                let shabbatHtml = '<h2>Next Shabbat Times</h2><div class="shabbat-times">';
                data.items.forEach(item => {
                    const time = new Date(item.date).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    shabbatHtml += `
                        <div>
                            <strong>${item.title}:</strong> ${time}
                        </div>
                    `;
                });
                shabbatHtml += '</div>';
                document.getElementById('shabbat').innerHTML = shabbatHtml;
            } catch (error) {
                document.getElementById('shabbat').innerHTML = `Error fetching Shabbat times: ${error.message}`;
            }
        }

        async function fetchNextHoliday(lat, lon) {
            const today = new Date();
            const endDate = new Date();
            endDate.setMonth(endDate.getMonth() + 3); // Look ahead 3 months

            const url = `https://www.hebcal.com/hebcal?cfg=json&v=1&latitude=${lat}&longitude=${lon}&start=${today.toISOString().split('T')[0]}&end=${endDate.toISOString().split('T')[0]}&maj=on`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                // Filter for the next major holiday
                const nextHoliday = data.items.find(item => 
                    item.category === 'holiday' && new Date(item.date) >= today
                );

                if (nextHoliday) {
                    const holidayDate = new Date(nextHoliday.date);
                    const formattedDate = holidayDate.toLocaleDateString('en-US', {
                        weekday: 'long',
                        month: 'long',
                        day: 'numeric'
                    });

                    return `
                        <div class="next-holiday">
                            <h3>Next Holiday</h3>
                            <div class="holiday-info">
                                <strong>${nextHoliday.title}</strong><br>
                                ${formattedDate}
                            </div>
                        </div>
                    `;
                }
                return '';
            } catch (error) {
                console.error('Error fetching holiday:', error);
                return '<div class="error">Error fetching holiday information</div>';
            }
        }

        // Optional: Calculate on page load if coordinates are already present
        window.onload = function() {
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            if (lat && lon) {
                calculateAll();
            }
        };
    </script>
</body>
</html>
